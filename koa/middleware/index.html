<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa中间件大揭秘 | YingChen Blog</title>
    <meta name="description" content="记录自己工作和学习当中遇到的一些有趣的东西">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.a7106b77.css" as="style"><link rel="preload" href="/assets/js/app.4bc2ad38.js" as="script"><link rel="preload" href="/assets/js/2.8001882b.js" as="script"><link rel="preload" href="/assets/js/8.23c48231.js" as="script"><link rel="prefetch" href="/assets/js/10.a31b3f8f.js"><link rel="prefetch" href="/assets/js/11.4be96477.js"><link rel="prefetch" href="/assets/js/12.7dcf133a.js"><link rel="prefetch" href="/assets/js/13.1c31c982.js"><link rel="prefetch" href="/assets/js/14.1f4f2c2a.js"><link rel="prefetch" href="/assets/js/15.b0ceca04.js"><link rel="prefetch" href="/assets/js/16.b9d49c20.js"><link rel="prefetch" href="/assets/js/17.e1d66b04.js"><link rel="prefetch" href="/assets/js/18.70bfaa81.js"><link rel="prefetch" href="/assets/js/19.d442cccb.js"><link rel="prefetch" href="/assets/js/20.9524f043.js"><link rel="prefetch" href="/assets/js/21.a398f430.js"><link rel="prefetch" href="/assets/js/22.3e571c40.js"><link rel="prefetch" href="/assets/js/23.eeb6ae5b.js"><link rel="prefetch" href="/assets/js/24.7b331498.js"><link rel="prefetch" href="/assets/js/25.1bd06044.js"><link rel="prefetch" href="/assets/js/26.c8f48922.js"><link rel="prefetch" href="/assets/js/27.1a763c86.js"><link rel="prefetch" href="/assets/js/28.0e6e0420.js"><link rel="prefetch" href="/assets/js/29.88358b62.js"><link rel="prefetch" href="/assets/js/3.5c364248.js"><link rel="prefetch" href="/assets/js/30.cba2bdbc.js"><link rel="prefetch" href="/assets/js/31.366e3eb2.js"><link rel="prefetch" href="/assets/js/32.a3fbb37a.js"><link rel="prefetch" href="/assets/js/33.44ed4e43.js"><link rel="prefetch" href="/assets/js/34.4db0e6a8.js"><link rel="prefetch" href="/assets/js/35.197c746d.js"><link rel="prefetch" href="/assets/js/36.10c3e979.js"><link rel="prefetch" href="/assets/js/37.19f9cb72.js"><link rel="prefetch" href="/assets/js/38.6db8555b.js"><link rel="prefetch" href="/assets/js/39.8f709365.js"><link rel="prefetch" href="/assets/js/4.a0c1a2ff.js"><link rel="prefetch" href="/assets/js/40.2481e0d4.js"><link rel="prefetch" href="/assets/js/41.3f3fc7d5.js"><link rel="prefetch" href="/assets/js/42.a83552b7.js"><link rel="prefetch" href="/assets/js/43.98d9e3c4.js"><link rel="prefetch" href="/assets/js/44.2e00b004.js"><link rel="prefetch" href="/assets/js/45.66cfe1a0.js"><link rel="prefetch" href="/assets/js/46.f0e4dbf3.js"><link rel="prefetch" href="/assets/js/47.ebf746e7.js"><link rel="prefetch" href="/assets/js/48.9bc44561.js"><link rel="prefetch" href="/assets/js/49.ecd41f76.js"><link rel="prefetch" href="/assets/js/5.39fa385f.js"><link rel="prefetch" href="/assets/js/50.37d75534.js"><link rel="prefetch" href="/assets/js/51.f7042b23.js"><link rel="prefetch" href="/assets/js/52.027bcdb7.js"><link rel="prefetch" href="/assets/js/53.f6f3538e.js"><link rel="prefetch" href="/assets/js/54.26552382.js"><link rel="prefetch" href="/assets/js/55.57a19ad0.js"><link rel="prefetch" href="/assets/js/56.d71e9097.js"><link rel="prefetch" href="/assets/js/57.135923c3.js"><link rel="prefetch" href="/assets/js/58.2a4d0504.js"><link rel="prefetch" href="/assets/js/59.ebcb73f2.js"><link rel="prefetch" href="/assets/js/6.b68f40f8.js"><link rel="prefetch" href="/assets/js/60.f322e13b.js"><link rel="prefetch" href="/assets/js/61.0aa270df.js"><link rel="prefetch" href="/assets/js/62.129424fd.js"><link rel="prefetch" href="/assets/js/63.b0753bae.js"><link rel="prefetch" href="/assets/js/64.a101b529.js"><link rel="prefetch" href="/assets/js/65.aee7e46b.js"><link rel="prefetch" href="/assets/js/66.bebba830.js"><link rel="prefetch" href="/assets/js/7.588b7ab3.js"><link rel="prefetch" href="/assets/js/9.1f23aeef.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a7106b77.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">YingChen Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/require/" class="nav-link">
  node核心
</a></li><li class="dropdown-item"><!----> <a href="/koa/read/" class="nav-link">
  koa核心
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/YIngChenIt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/require/" class="nav-link">
  node核心
</a></li><li class="dropdown-item"><!----> <a href="/koa/read/" class="nav-link">
  koa核心
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/YIngChenIt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工作新发现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/work/poster-edit/" class="sidebar-link">【方案】-海报编辑器</a></li><li><a href="/work/weapp-structure/" class="sidebar-link">【方案】-基于tina + gulp4 + webpack的小程序构建方案</a></li><li><a href="/work/vuex/" class="sidebar-link">【优化】-实现vuex数据持久化插件</a></li><li><a href="/work/weapp-event/" class="sidebar-link">【方案】-小程序跨页面通信解决方案</a></li><li><a href="/work/weapp-maidian/" class="sidebar-link">【方案】-基于tina的小程序埋点方案</a></li><li><a href="/work/imgoss/" class="sidebar-link">【优化】-图片自动上传oss-plugin</a></li><li><a href="/work/loadmore-list/" class="sidebar-link">【优化】 -封装一个自动加载更多的组件</a></li><li><a href="/work/sticky/" class="sidebar-link">【小技巧】-滚动置顶还能这么玩</a></li><li><a href="/work/autobuild/" class="sidebar-link">【小技巧】-小程序自动发布体验版脚本</a></li><li><a href="/work/saoma/" class="sidebar-link">【技术原理】-扫码登陆的基本原理</a></li><li><a href="/work/gulp-node-v/" class="sidebar-link">【采坑】-gulp 和 node版本不兼容</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>react核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react-base/" class="sidebar-link">这里有一份react的基础进阶</a></li><li><a href="/react/redux/" class="sidebar-link">手摸手实现Redux</a></li><li><a href="/react/redux-middleware/" class="sidebar-link">深入了解redux的中间件机制</a></li><li><a href="/react/react-redux/" class="sidebar-link">手摸手实现react-redux</a></li><li><a href="/react/react-router/" class="sidebar-link">手摸手实现react-router</a></li><li><a href="/react/react-hooks-base/" class="sidebar-link">react-hooks 的新特性</a></li><li><a href="/react/react-hooks/" class="sidebar-link">手摸手实现 react-hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/observer/" class="sidebar-link">深入了解Vue响应式特点</a></li><li><a href="/vue/compiler/" class="sidebar-link">【源码】手写mvvm 之 Compiler类</a></li><li><a href="/vue/watcher/" class="sidebar-link">【源码】手写mvvm 之 实现数据双向绑定</a></li><li><a href="/vue/computed/" class="sidebar-link">【源码】Computed 源码解析</a></li><li><a href="/vue/next-tick/" class="sidebar-link">【源码】nextTick 源码解析</a></li><li><a href="/vue/mixin/" class="sidebar-link">【源码】mixin 源码解析</a></li><li><a href="/vue/watch/" class="sidebar-link">【源码】watch 源码解析</a></li><li><a href="/vue/life/" class="sidebar-link">【源码】生命周期 源码解析</a></li><li><a href="/vue/components/" class="sidebar-link">Vue中组件通信的九种方法</a></li><li><a href="/vue/router/" class="sidebar-link">实现一个vue-router</a></li><li><a href="/vue/vuex/" class="sidebar-link">实现一个vuex</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>服务端渲染</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ssr/react/" class="sidebar-link">React + Express 服务端渲染采坑日记</a></li><li><a href="/ssr/vue/" class="sidebar-link">Vue + koa 服务端渲染采坑日记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>webpack核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webpack/bundle/" class="sidebar-link">webpack打包出的文件解析</a></li><li><a href="/webpack/config/" class="sidebar-link">webpack基础配置大纲</a></li><li><a href="/webpack/more/" class="sidebar-link">webpack配置进阶</a></li><li><a href="/webpack/optimize/" class="sidebar-link">webpack性能优化</a></li><li><a href="/webpack/mini-webpack/" class="sidebar-link">实现一个mini-webpack</a></li><li><a href="/webpack/loader/" class="sidebar-link">实现常用的loader</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/base/horderFun/" class="sidebar-link">高阶函数的应用</a></li><li><a href="/base/promise/" class="sidebar-link">实现符合A+规范的Promise</a></li><li><a href="/base/generator/" class="sidebar-link">generator及co库原理</a></li><li><a href="/base/es6/" class="sidebar-link">ES6食用指南</a></li><li><a href="/base/deepcopy/" class="sidebar-link">深拷贝和浅拷贝</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/require/" class="sidebar-link">你不知道的require</a></li><li><a href="/node/event/" class="sidebar-link">events-观察者模式</a></li><li><a href="/node/cache/" class="sidebar-link">说说缓存的那些事</a></li><li><a href="/node/buffer/" class="sidebar-link">深入浅出Buffer</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>flutter</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/flutter/anzhuang/" class="sidebar-link">flutter开发环境配置采坑</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>koa核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/koa/read/" class="sidebar-link">koa源码分析-从入门到看不懂</a></li><li><a href="/koa/mini-koa/" class="sidebar-link">手摸手撸一个mini-koa</a></li><li><a href="/koa/middleware/" class="active sidebar-link">koa中间件大揭秘</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/koa/middleware/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/koa/middleware/#koa-bodyparser" class="sidebar-link">koa-bodyparser</a></li><li class="sidebar-sub-header"><a href="/koa/middleware/#koa-static" class="sidebar-link">koa-static</a></li><li class="sidebar-sub-header"><a href="/koa/middleware/#koa-router" class="sidebar-link">koa-router</a></li><li class="sidebar-sub-header"><a href="/koa/middleware/#koa-views" class="sidebar-link">koa-views</a></li><li class="sidebar-sub-header"><a href="/koa/middleware/#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>typescript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/typescript/one/" class="sidebar-link">typescript(一) - 数据类型</a></li><li><a href="/typescript/two/" class="sidebar-link">typescript(二) - 函数</a></li><li><a href="/typescript/three/" class="sidebar-link">typescript(三) - 类</a></li><li><a href="/typescript/four/" class="sidebar-link">typescript(四) - 接口</a></li><li><a href="/typescript/five/" class="sidebar-link">typescript(五) - 泛型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>PWA</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pwa/init/" class="sidebar-link">pwa 初体验</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>LeetCode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leetcode/10/" class="sidebar-link">10月</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa中间件大揭秘"><a href="#koa中间件大揭秘" class="header-anchor">#</a> koa中间件大揭秘</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>我们在使用koa的时候发现，其实koa只是对req，res进行了封装，但是很多一些功能如路由、静态资源、模板引擎等都没有支持，看过源码都知道koa的源码就那么一点。但是丰富的第三方中间件弥补了这个不足。接下来我们来揭开一下一些常用中间件的内部原理，你会发现其实koa的中间件真的大同小异。</p> <h2 id="koa-bodyparser"><a href="#koa-bodyparser" class="header-anchor">#</a> koa-bodyparser</h2> <p>我们先来简单看下 <code>koa-bodyparser</code> 的基本用法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-bodyparser&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 挂载中间件 koa-bodyparser</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 渲染一个表单，表单提交时候请求接口 /login</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;GET&quot;</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">&quot;/form&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            &lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
                &lt;input type=&quot;text&quot; name=&quot;username&quot;/&gt;
                &lt;input type=&quot;text&quot; name=&quot;password&quot;/&gt;
                &lt;button&gt;提交&lt;/button&gt;
            &lt;/form&gt;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;POST&quot;</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span> <span class="token comment">//将接口得到的数据展示在页面上</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码其实很简单，<code>/form</code> 路由渲染一个表单组件，表单组件请求的是<code>/login</code> 路由，而<code>/login</code>将得到的数据渲染在页面，我们来看下运行效果:</p> <p><img src="/assets/img/koa1.d6b13ab4.gif" alt="An image"></p> <p>知道 <code>koa-bodyparser</code> 的基本用法之后，我们试一下自己实现一个类似功能的中间件</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">bodyParser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 返回一个async函数</span>
        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将文件流赋值给 ctx.request.body</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实你会发现，内部就是这么简单，而且不难发现，<code>app.use()</code> 方法在 <code>koa</code> 中是接受一个 <code>async</code>函数的，根据<code>app.use(bodyParser())</code> 来挂载中间件我们可以知道 <code>bodyParser()</code> 返回的就是一个 <code>async</code> 函数，而中间件的核心原理则是利用 <code>koa</code> 中间件的洋葱机制，在一开始给 <code>ctx</code> 上挂载一些属性或者方法，则在后面的 <code>arr.use()</code> 中都可以通过 <code>ctx</code>来拿到对应挂载的方法。</p> <h2 id="koa-static"><a href="#koa-static" class="header-anchor">#</a> koa-static</h2> <p><code>koa-static</code> 的作用用一句话来概括就是，起一个静态服务，下面看下具体用法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上代码的意思是，以当前目录为根目录起一个静态服务，通过 <code>http://localhost:5050/XXX</code> 就可以获取到对应的资源了。</p> <p>而且不难发现，<code>koa-static</code> 的用法和 <code>koa-bodyparser</code> 很像，都是<code>app.use(xxx())</code> 的形式，那我们就来简单实现一个这个效果</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token parameter">pathname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// 因为 fs.stat 主要通过报错来判断当前路径文件存不存在 所以try catch处理</span>
            <span class="token keyword">let</span> filePath <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path
            filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span> <span class="token comment">// 拿到绝对路径</span>
            <span class="token keyword">let</span> statObj <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statObj<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果是目录，则拼接上 `index.html` </span>
                filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token comment">//读取处理过的路径，然后返回</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 如果处理不了 就走下一个中间件</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>原理很简单，就是读当前传入路径的文件，有的话就赋值给 <code>ctx.body</code> , 没有的话走下一个中间件</p> <h2 id="koa-router"><a href="#koa-router" class="header-anchor">#</a> koa-router</h2> <p>顾名思义，一个路由的第三方中间件，我们直接看它的基础用法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上诉代码主要是起一个<code>/hello</code>的<code>get</code>请求接口，返回<code>hello</code>, 大大的简化了<code>koa</code>对路由的操作，如<code>ctx.method === &quot;GET&quot; &amp;&amp; ctx.path === &quot;/hello&quot;</code> 类似的判断，我们自己实现的时候需要注意到一些细节，如 <code>Router</code> 是一个类，<code>app.use()</code>挂载的是类上<code>routes</code>方法返回的函数，我们试下来实现一款简单的<code>koa-router</code>.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Layer</span><span class="token punctuation">{</span> <span class="token comment">//将栈中的结构抽取一个类 方便后序扩展</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pathname <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>method</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//将匹配方法抽离出来</span>
        <span class="token keyword">return</span> path <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pathname <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Router</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 这里面存放着所有的路由关系</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 我们次调用get方法都会像内部数组放一层</span>
        <span class="token keyword">let</span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter">fns<span class="token punctuation">,</span>ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// compose原理 和koa类似 先抽取栈中的第一个执行, 将下一个函数作为第一个函数的参数next，以此递归</span>
        <span class="token keyword">let</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">===</span> fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 边界值判断 避免爆了</span>
            <span class="token keyword">let</span> callback <span class="token operator">=</span> fns<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>callback<span class="token punctuation">;</span><span class="token comment">// 拿到栈中每一项执行</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">// 获取请求的路径</span>
            <span class="token keyword">let</span> path <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">;</span> <span class="token comment">// /hello</span>
            <span class="token keyword">let</span> method <span class="token operator">=</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">;</span> <span class="token comment">// get</span>
            <span class="token keyword">let</span> fns <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token operator">=&gt;</span>layer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在存储的路由表中筛选出符合条件项</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>fns<span class="token punctuation">,</span>ctx<span class="token punctuation">,</span>next<span class="token punctuation">)</span> <span class="token comment">// 进行组合</span>
       <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Router<span class="token punctuation">;</span>
</code></pre></div><p>我们慢慢来体会一下 <code>koa-router</code> 的内部流程
首先我们使用<code>route.get('/xxx', callback)</code> 的时候会调用 <code>Router</code>类上的<code>get</code>方法，该方法会将 <code>method</code> <code>path</code> <code>callback</code> 通过 <code>Layer</code> 类组装一下，存入 <code>stack</code>中，我们 <code>statck</code>的结构如下</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>然后我们调用 <code>route.routes()</code> 的时候，会根据当前请求的方法和路径去 <code>stack</code>中筛选出符合条件的项，将他们组合成一个大的函数，内部原理是和<code>koa</code>的中间件原理一样的，先执行第一个函数，将下一个函数作为第一个函数的参数<code>next</code></p> <p><img src="/assets/img/STACK2.29183c76.png" alt="An image"></p> <p>其实这只是实现<code>koa-router</code> 的一小部分内容，还有很多如二级路由啊、参数处理啥的比较恶心，这里就不写了</p> <h2 id="koa-views"><a href="#koa-views" class="header-anchor">#</a> koa-views</h2> <p>一句话来说 <code>koa-views</code>就是用来实现模板引擎的，很简单</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> views <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">views</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    map<span class="token operator">:</span> <span class="token punctuation">{</span>
        html<span class="token operator">:</span> <span class="token string">'ejs'</span> <span class="token comment">//如果遇到.html 后缀的文件，用ejs模板处理</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token parameter">ctx</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'zf'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>先来理一下<code>koa-views</code> 的基本用法吧，首先挂载中间件，声明一些参数，如 遇到<code>.html</code> 后缀的文件用 <code>ejs</code> 模板引擎来渲染，最后在  <code>ctx</code>上挂载一个<code>render()</code>方法，传入对应的数据来渲染对应的页面。知道原理之后，我们不妨自己来实现一下</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">views</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dirname<span class="token punctuation">,</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 将方法挂载到 ctx.render</span>
            <span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 引用ejs模板 这里的做法有点low 其实应该遍历取出的</span>
            <span class="token keyword">const</span> renderFile <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>ejs<span class="token punctuation">.</span>renderFile<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用ejs的方法渲染页面</span>
            <span class="token comment">// 渲染文件，成功后将结果返回去</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">renderFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>filename<span class="token operator">+</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 增加逻辑后 继续向下执行 koa-static</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>通过对工作做经常用到的几个中间件进行了一波深入了解，相信大家对<code>koa</code>中间件的路子和形式都摸得差不多了。核心原理就是利用<code>koa</code>中的洋葱模型，一开始往<code>ctx</code>上挂载自己需要的属性或者方法，后序就可以通过<code>ctx</code>来调用啦。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/koa/mini-koa/" class="prev">
        手摸手撸一个mini-koa
      </a></span> <span class="next"><a href="/typescript/one/">
        typescript(一) - 数据类型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4bc2ad38.js" defer></script><script src="/assets/js/2.8001882b.js" defer></script><script src="/assets/js/8.23c48231.js" defer></script>
  </body>
</html>
