<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入了解redux的中间件机制 | YingChen Blog</title>
    <meta name="description" content="记录自己工作和学习当中遇到的一些有趣的东西">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.a7106b77.css" as="style"><link rel="preload" href="/assets/js/app.4bc2ad38.js" as="script"><link rel="preload" href="/assets/js/2.8001882b.js" as="script"><link rel="preload" href="/assets/js/7.588b7ab3.js" as="script"><link rel="prefetch" href="/assets/js/10.a31b3f8f.js"><link rel="prefetch" href="/assets/js/11.4be96477.js"><link rel="prefetch" href="/assets/js/12.7dcf133a.js"><link rel="prefetch" href="/assets/js/13.1c31c982.js"><link rel="prefetch" href="/assets/js/14.1f4f2c2a.js"><link rel="prefetch" href="/assets/js/15.b0ceca04.js"><link rel="prefetch" href="/assets/js/16.b9d49c20.js"><link rel="prefetch" href="/assets/js/17.e1d66b04.js"><link rel="prefetch" href="/assets/js/18.70bfaa81.js"><link rel="prefetch" href="/assets/js/19.d442cccb.js"><link rel="prefetch" href="/assets/js/20.9524f043.js"><link rel="prefetch" href="/assets/js/21.a398f430.js"><link rel="prefetch" href="/assets/js/22.3e571c40.js"><link rel="prefetch" href="/assets/js/23.eeb6ae5b.js"><link rel="prefetch" href="/assets/js/24.7b331498.js"><link rel="prefetch" href="/assets/js/25.1bd06044.js"><link rel="prefetch" href="/assets/js/26.c8f48922.js"><link rel="prefetch" href="/assets/js/27.1a763c86.js"><link rel="prefetch" href="/assets/js/28.0e6e0420.js"><link rel="prefetch" href="/assets/js/29.88358b62.js"><link rel="prefetch" href="/assets/js/3.5c364248.js"><link rel="prefetch" href="/assets/js/30.cba2bdbc.js"><link rel="prefetch" href="/assets/js/31.366e3eb2.js"><link rel="prefetch" href="/assets/js/32.a3fbb37a.js"><link rel="prefetch" href="/assets/js/33.44ed4e43.js"><link rel="prefetch" href="/assets/js/34.4db0e6a8.js"><link rel="prefetch" href="/assets/js/35.197c746d.js"><link rel="prefetch" href="/assets/js/36.10c3e979.js"><link rel="prefetch" href="/assets/js/37.19f9cb72.js"><link rel="prefetch" href="/assets/js/38.6db8555b.js"><link rel="prefetch" href="/assets/js/39.8f709365.js"><link rel="prefetch" href="/assets/js/4.a0c1a2ff.js"><link rel="prefetch" href="/assets/js/40.2481e0d4.js"><link rel="prefetch" href="/assets/js/41.3f3fc7d5.js"><link rel="prefetch" href="/assets/js/42.a83552b7.js"><link rel="prefetch" href="/assets/js/43.98d9e3c4.js"><link rel="prefetch" href="/assets/js/44.2e00b004.js"><link rel="prefetch" href="/assets/js/45.66cfe1a0.js"><link rel="prefetch" href="/assets/js/46.f0e4dbf3.js"><link rel="prefetch" href="/assets/js/47.ebf746e7.js"><link rel="prefetch" href="/assets/js/48.9bc44561.js"><link rel="prefetch" href="/assets/js/49.ecd41f76.js"><link rel="prefetch" href="/assets/js/5.39fa385f.js"><link rel="prefetch" href="/assets/js/50.37d75534.js"><link rel="prefetch" href="/assets/js/51.f7042b23.js"><link rel="prefetch" href="/assets/js/52.027bcdb7.js"><link rel="prefetch" href="/assets/js/53.f6f3538e.js"><link rel="prefetch" href="/assets/js/54.26552382.js"><link rel="prefetch" href="/assets/js/55.57a19ad0.js"><link rel="prefetch" href="/assets/js/56.d71e9097.js"><link rel="prefetch" href="/assets/js/57.135923c3.js"><link rel="prefetch" href="/assets/js/58.2a4d0504.js"><link rel="prefetch" href="/assets/js/59.ebcb73f2.js"><link rel="prefetch" href="/assets/js/6.b68f40f8.js"><link rel="prefetch" href="/assets/js/60.f322e13b.js"><link rel="prefetch" href="/assets/js/61.0aa270df.js"><link rel="prefetch" href="/assets/js/62.129424fd.js"><link rel="prefetch" href="/assets/js/63.b0753bae.js"><link rel="prefetch" href="/assets/js/64.a101b529.js"><link rel="prefetch" href="/assets/js/65.aee7e46b.js"><link rel="prefetch" href="/assets/js/66.bebba830.js"><link rel="prefetch" href="/assets/js/8.23c48231.js"><link rel="prefetch" href="/assets/js/9.1f23aeef.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a7106b77.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">YingChen Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/require/" class="nav-link">
  node核心
</a></li><li class="dropdown-item"><!----> <a href="/koa/read/" class="nav-link">
  koa核心
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/YIngChenIt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/require/" class="nav-link">
  node核心
</a></li><li class="dropdown-item"><!----> <a href="/koa/read/" class="nav-link">
  koa核心
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/YIngChenIt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工作新发现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/work/poster-edit/" class="sidebar-link">【方案】-海报编辑器</a></li><li><a href="/work/weapp-structure/" class="sidebar-link">【方案】-基于tina + gulp4 + webpack的小程序构建方案</a></li><li><a href="/work/vuex/" class="sidebar-link">【优化】-实现vuex数据持久化插件</a></li><li><a href="/work/weapp-event/" class="sidebar-link">【方案】-小程序跨页面通信解决方案</a></li><li><a href="/work/weapp-maidian/" class="sidebar-link">【方案】-基于tina的小程序埋点方案</a></li><li><a href="/work/imgoss/" class="sidebar-link">【优化】-图片自动上传oss-plugin</a></li><li><a href="/work/loadmore-list/" class="sidebar-link">【优化】 -封装一个自动加载更多的组件</a></li><li><a href="/work/sticky/" class="sidebar-link">【小技巧】-滚动置顶还能这么玩</a></li><li><a href="/work/autobuild/" class="sidebar-link">【小技巧】-小程序自动发布体验版脚本</a></li><li><a href="/work/saoma/" class="sidebar-link">【技术原理】-扫码登陆的基本原理</a></li><li><a href="/work/gulp-node-v/" class="sidebar-link">【采坑】-gulp 和 node版本不兼容</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react-base/" class="sidebar-link">这里有一份react的基础进阶</a></li><li><a href="/react/redux/" class="sidebar-link">手摸手实现Redux</a></li><li><a href="/react/redux-middleware/" class="active sidebar-link">深入了解redux的中间件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux-middleware/#redux中间件基本原理初认识" class="sidebar-link">redux中间件基本原理初认识</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#实现-redux-logger" class="sidebar-link">实现 redux-logger</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#实现-redux-thunk" class="sidebar-link">实现 redux-thunk</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#实现-redux-promise" class="sidebar-link">实现 redux-promise</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#applymiddleware优化" class="sidebar-link">applyMiddleware优化</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#compose方法" class="sidebar-link">compose方法</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#实现联级" class="sidebar-link">实现联级</a></li><li class="sidebar-sub-header"><a href="/react/redux-middleware/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/react/react-redux/" class="sidebar-link">手摸手实现react-redux</a></li><li><a href="/react/react-router/" class="sidebar-link">手摸手实现react-router</a></li><li><a href="/react/react-hooks-base/" class="sidebar-link">react-hooks 的新特性</a></li><li><a href="/react/react-hooks/" class="sidebar-link">手摸手实现 react-hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/observer/" class="sidebar-link">深入了解Vue响应式特点</a></li><li><a href="/vue/compiler/" class="sidebar-link">【源码】手写mvvm 之 Compiler类</a></li><li><a href="/vue/watcher/" class="sidebar-link">【源码】手写mvvm 之 实现数据双向绑定</a></li><li><a href="/vue/computed/" class="sidebar-link">【源码】Computed 源码解析</a></li><li><a href="/vue/next-tick/" class="sidebar-link">【源码】nextTick 源码解析</a></li><li><a href="/vue/mixin/" class="sidebar-link">【源码】mixin 源码解析</a></li><li><a href="/vue/watch/" class="sidebar-link">【源码】watch 源码解析</a></li><li><a href="/vue/life/" class="sidebar-link">【源码】生命周期 源码解析</a></li><li><a href="/vue/components/" class="sidebar-link">Vue中组件通信的九种方法</a></li><li><a href="/vue/router/" class="sidebar-link">实现一个vue-router</a></li><li><a href="/vue/vuex/" class="sidebar-link">实现一个vuex</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>服务端渲染</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ssr/react/" class="sidebar-link">React + Express 服务端渲染采坑日记</a></li><li><a href="/ssr/vue/" class="sidebar-link">Vue + koa 服务端渲染采坑日记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>webpack核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webpack/bundle/" class="sidebar-link">webpack打包出的文件解析</a></li><li><a href="/webpack/config/" class="sidebar-link">webpack基础配置大纲</a></li><li><a href="/webpack/more/" class="sidebar-link">webpack配置进阶</a></li><li><a href="/webpack/optimize/" class="sidebar-link">webpack性能优化</a></li><li><a href="/webpack/mini-webpack/" class="sidebar-link">实现一个mini-webpack</a></li><li><a href="/webpack/loader/" class="sidebar-link">实现常用的loader</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/base/horderFun/" class="sidebar-link">高阶函数的应用</a></li><li><a href="/base/promise/" class="sidebar-link">实现符合A+规范的Promise</a></li><li><a href="/base/generator/" class="sidebar-link">generator及co库原理</a></li><li><a href="/base/es6/" class="sidebar-link">ES6食用指南</a></li><li><a href="/base/deepcopy/" class="sidebar-link">深拷贝和浅拷贝</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/require/" class="sidebar-link">你不知道的require</a></li><li><a href="/node/event/" class="sidebar-link">events-观察者模式</a></li><li><a href="/node/cache/" class="sidebar-link">说说缓存的那些事</a></li><li><a href="/node/buffer/" class="sidebar-link">深入浅出Buffer</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>flutter</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/flutter/anzhuang/" class="sidebar-link">flutter开发环境配置采坑</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>koa核心原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/koa/read/" class="sidebar-link">koa源码分析-从入门到看不懂</a></li><li><a href="/koa/mini-koa/" class="sidebar-link">手摸手撸一个mini-koa</a></li><li><a href="/koa/middleware/" class="sidebar-link">koa中间件大揭秘</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>typescript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/typescript/one/" class="sidebar-link">typescript(一) - 数据类型</a></li><li><a href="/typescript/two/" class="sidebar-link">typescript(二) - 函数</a></li><li><a href="/typescript/three/" class="sidebar-link">typescript(三) - 类</a></li><li><a href="/typescript/four/" class="sidebar-link">typescript(四) - 接口</a></li><li><a href="/typescript/five/" class="sidebar-link">typescript(五) - 泛型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>PWA</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pwa/init/" class="sidebar-link">pwa 初体验</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>LeetCode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/leetcode/10/" class="sidebar-link">10月</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入了解redux的中间件机制"><a href="#深入了解redux的中间件机制" class="header-anchor">#</a> 深入了解redux的中间件机制</h1> <h2 id="redux中间件基本原理初认识"><a href="#redux中间件基本原理初认识" class="header-anchor">#</a> redux中间件基本原理初认识</h2> <p>我们先来体会一下redux中间件的基本原理，假设现在有一个需求，我们希望每次dispatch的时候打印出上一个状态的值，当前的action以及下一个状态的值，通常我们会这样做，重写dispatch方法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// store/index.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducers'</span>
<span class="token keyword">let</span> store <span class="token operator">=</span>  <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
<span class="token keyword">let</span> oldDispatch <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch <span class="token comment">// 缓存原生的siapatch</span>
store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 重写dispatch方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prev state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token function">oldDispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><p>其实这就是我们redux中间件最简单的原理了，先把原生的dispatch方法缓存起来，然后重写dispatch方法，最后调用缓存起来的dispatch方法，学过vue的同学可能知道，这个思路是不是和vue实现数组方法触发响应式一样呀</p> <h2 id="实现-redux-logger"><a href="#实现-redux-logger" class="header-anchor">#</a> 实现 redux-logger</h2> <p>既然我们已经知道了redux中间件的大致思路了，然后我们来看下redux中怎么使用中间件，然后实现和使用我们的第一个中间件</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducers'</span>

<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// next 代表下一个中间件</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// action动作</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prev state'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next state'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><p>我们可以发现我们引入了一个新的函数<code>applyMiddleware</code>, 它接收的第一个参数是中间件, 第二个参数是 <code>createStore</code>方法, 第三个参数是<code>reducer</code></p> <p>然后值得一提的是, redux的中间件格式都是固定的，如上述<code>logger</code>中间件一致，至于为什么是这样的格式，这一点我们暂时不用理会，到下文中实现联级(将多个中间件连成一个类似于洋葱模型的结构)的时候你才会体验到这种结构的妙处.</p> <p>我们在上文中之后中间件的基本原理无非是重写dispatch方法，那么我们大致可以猜到<code>applyMiddleware</code>方法的作用就是在内部重写dispatch方法，然后返回store。我们试下来实现它的基本结构吧</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
            <span class="token keyword">return</span> store
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在大致知道为什么需要将<code>createStore</code> 和 <code>reducer</code> 作为参数传入了吧，那现在我们试下改动他，让他支持我们的<code>logger</code>中间件</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
            <span class="token keyword">let</span> middlewareApi <span class="token operator">=</span> <span class="token punctuation">{</span>
                getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
                dispatch<span class="token operator">:</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            middleware <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareApi<span class="token punctuation">)</span>
            <span class="token keyword">let</span> dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span> <span class="token comment">// 下一个中间件是原生的dispatch</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>store<span class="token punctuation">,</span>
                dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实是不是就是我们的中间件基本原理，重写dispatch方法，那我们接下来在实现几个常用的中间件吧</p> <h2 id="实现-redux-thunk"><a href="#实现-redux-thunk" class="header-anchor">#</a> 实现 redux-thunk</h2> <p>先来了解一下<code>redux-thunk</code>的作用，我们知道原生redux中的dispatch只可以派发action，换句话来说就是只可以派发对象，那<code>redux-thunk</code>的作用就是让我们的dispatch可以派发一个函数，例如我们先写一个点击延迟一毫秒加一的<code>actionCreator</code></p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncincrement</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">,</span>
                payload<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以发现这个<code>actionCreator</code>返回的是一个函数，不是一个对象，我们原生的dispatch方法肯定不支持这种写法，所以<code>redux-thunk</code>中间件就出来了，我们来实现一下</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">thunk</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果是一个函数 函数执行 将 dispatch, getState作为参数传入</span>
                <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现-redux-promise"><a href="#实现-redux-promise" class="header-anchor">#</a> 实现 redux-promise</h2> <p>同样道理，我们也想要dispatch可以派发promise, 所以<code>redux-promise</code>来了，我们先来看下<code>actionCreator</code>, 功能也是延迟一秒+1</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">promiseincrement</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token punctuation">,</span>
                payload<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那我们来实现一下<code>redux-promise</code></p> <div class="language-JS extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">promise</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断是不是一个promise</span>
                <span class="token keyword">return</span> action<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="applymiddleware优化"><a href="#applymiddleware优化" class="header-anchor">#</a> applyMiddleware优化</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>我们先不要急，一步一步来，很快一切谜底就揭晓了</p></div> <p>在实现中间件联级之前，我们需要优化一下<code>applyMiddleware</code> 方法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
            <span class="token keyword">let</span> middlewareApi <span class="token operator">=</span> <span class="token punctuation">{</span>
                getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
                dispatch<span class="token operator">:</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            middleware <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareApi<span class="token punctuation">)</span>
            <span class="token keyword">let</span> dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span> <span class="token comment">// 下一个中间件是原生的dispatch</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>store<span class="token punctuation">,</span>
                dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以发现, middlewareApi 里面的 dispatch 是不是永远取得是原生store下面的dispatch啊，这个很明显不符合我们中间件洋葱模型。我们希望的是dispatch是包装后的dispatch，我们画个图来理解一下，假设我们现在中间件包了2层</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>按照之前的写法，我们执行完第一个中间件thunk之后，是不是直接走的原生的store.dispatch</p> <p>我们看这行代码</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br></div><pre class="language-js"><code><span class="token keyword">let</span> dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
</code></pre></div><p>这样肯定不行吧，因为我们绕过了logger中间件，我们的预期是如果thunk中间件匹配上了，然后改造完dispatch之后，从头再来，然后执行logger中间件吧。我们来改造下代码</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
            <span class="token keyword">let</span> dispatch
            <span class="token keyword">let</span> middlewareApi <span class="token operator">=</span> <span class="token punctuation">{</span>
                getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
                <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            middleware <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareApi<span class="token punctuation">)</span>
            dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span> 
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>store<span class="token punctuation">,</span>
                dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们先声明一个dispatch，第一次执行的时候是undefined，所以无需理会，当代码走到</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br></div><pre class="language-js"><code> dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
</code></pre></div><p>的时候，我们可以知道dispatch已经给赋值于thunk中间件(也就是第一个中间件改造后的dispatch或者原生store.dispatch)，这样是不是就可以达到我们的目的了</p> <h2 id="compose方法"><a href="#compose方法" class="header-anchor">#</a> compose方法</h2> <p>redux中间件的设计很绕，可能看到这还是很迷糊的，这个是很正常的，一切待解释到如何实现联级中间件的时候，一切都懂了，但是在那之前，我们先来说一个 <code>compose</code> 方法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add3</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add3</span><span class="token punctuation">(</span><span class="token function">add2</span><span class="token punctuation">(</span><span class="token function">add1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 7</span>
</code></pre></div><p>这是很常见的一种函数内嵌调用吧，<code>compose</code> 方法的作用就是解决这种比较难看的内嵌调用的</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add3</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>add3<span class="token punctuation">,</span> add2<span class="token punctuation">,</span> add1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里就不仔细说他的内部原理了，有兴趣的同学可以自己打输出断点研究下</p> <h2 id="实现联级"><a href="#实现联级" class="header-anchor">#</a> 实现联级</h2> <p>我们先来看使用方法</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br></div><pre class="language-js"><code><span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> thunk<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
</code></pre></div><p>我们的<code>applyMiddleware</code>的第一个参数传入的是全部的中间件了，我们先来实现它，然后再来体会逻辑</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
            <span class="token keyword">let</span> dispatch
            <span class="token keyword">let</span> middlewareApi <span class="token operator">=</span> <span class="token punctuation">{</span>
                getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
                <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            middlewares <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareApi<span class="token punctuation">)</span><span class="token punctuation">)</span>
            dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>store<span class="token punctuation">,</span>
                dispatch<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来一步一步分析，首先我们看下经过处理之后的<code>middlewares</code>是啥</p> <p><img src="/assets/img/img2.f703a525.png" alt="An image"></p> <p>我们可以发现, <code>middlewares</code> 是全部中间件第一次执行的返回值，也就是</p> <p><img src="/assets/img/img3.b9d0b9c6.png" alt="An image"></p> <p>的这个部分，然后根据我们对compose方法的理解，会将上述框起来的三个函数转化成类似于<code>add3(add2(add1(1)))</code>的写法,也就是类似于</p> <p><img src="/assets/img/img4.d8cb2a1f.png" alt="An image"></p> <p>当走到第一个中间件<code>redux-promise</code>的时候，如果匹配上了，就进行中间件重写dispatch，返回新的dispatch。如果匹配不上就走<code>next(action)</code>,
但是我们经过<code>compose</code>方法处理之后，这个next的值明显是第二个中间件函数执行的返回值，然后第二个中间件开始走相同的逻辑，直到最后走到了原生的store.dispatch方法</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>一开始接触redux的中间件的时候也很闷，不知道为什么中间件一定要遵守这种结构的写法，也不知道内部是如何处理中间件的，但是慢慢深入理解和多打几次代码和断点之后发现到了这个结构设计的巧妙之处，继续加油</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/redux/" class="prev">
        手摸手实现Redux
      </a></span> <span class="next"><a href="/react/react-redux/">
        手摸手实现react-redux
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4bc2ad38.js" defer></script><script src="/assets/js/2.8001882b.js" defer></script><script src="/assets/js/7.588b7ab3.js" defer></script>
  </body>
</html>
